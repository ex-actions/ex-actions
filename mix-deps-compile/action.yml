name: 'benstepp/elixir-actions/mix-deps-compile'
author: 'Benjamin Stepp'
description: 'Compiles and Caches your application dependencies'

inputs:
  working-directory:
    description: 'Path to your elixir application. This can be configured if
      your elixir application is in a subdirectory, for example if you are in a
      monorepo.'
    required: false

runs:
  using: 'composite'
  steps:
    - name: Determine Information
      id: deps-compile-info
      shell: bash
      run: |
        if [[ "${{ inputs.working-directory }}" ]]; then cd ${{ inputs.working-directory }}; fi
        echo "::set-output name=elixir-version::$(mix hex.info | grep 'Elixir:' | sed -n 's/Elixir://p' | sed -n 's/\s//pg')"
        echo "::set-output name=otp-version::$(mix hex.info | grep 'OTP:' | sed -n 's/OTP://p' | sed -n 's/\s//pg')"
        if [[ "${{ inputs.working-directory }}" ]]; then
          echo "::set-output name=build-path::${{ inputs.working-directory }}/_build_deps"
          echo "::set-output name=mix-lock-path::${{ inputs.working-directory }}/mix.lock"
        else
          echo "::set-output name=build-path::_build_deps"
          echo "::set-output name=mix-lock-path::mix.lock"
        fi

    - name: Cache Dependencies
      uses: actions/cache@v2
      id: cache-build-deps
      with:
        path: ${{ steps.deps-compile-info.outputs.build-path }}
        key: ${{runner.os}}-${{runner.arch}}-${{ steps.deps-compile-info.outputs.elixir-version }}-${{ steps.deps-compile-info.outputs.otp-version }}-builddeps-${{ steps.deps-compile-info.outputs.build-path }}-${{ env.MIX_ENV }}-${{ hashFiles( steps.deps-compile-info.outputs.mix-lock-path ) }}
        restore-keys: |
          ${{runner.os}}-${{runner.arch}}-${{ steps.deps-compile-info.outputs.elixir-version }}-${{ steps.deps-compile-info.outputs.otp-version }}-builddeps-${{ steps.deps-compile-info.outputs.build-path }}-${{ env.MIX_ENV }}-

    - name: Compile Dependencies
      if: steps.cache-build-deps.outputs.cache-hit != 'true'
      shell: bash
      env:
        MIX_BUILD_ROOT: '_build_deps'
      run: |
        if [[ "${{ inputs.working-directory }}" ]]; then cd ${{ inputs.working-directory }}; fi
        mkdir -p _build_deps
        mix deps.compile

    - name: Merge _build directory
      shell: bash
      run: |
        if [[ "${{ inputs.working-directory }}" ]]; then cd ${{ inputs.working-directory }}; fi
        mkdir -p _build/
        rsync -a _build_deps/ _build
