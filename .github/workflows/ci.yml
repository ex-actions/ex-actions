name: 'CI'

on:
  workflow_dispatch:
  pull_request:
    branches: ['main']
  push:
    branches: ['main']

env:
  MIX_ENV: 'test'
  elixir-version: '1.14.1'
  otp-version: '25.1.1'

jobs:
  setup:
    name: 'Setup Node.js'
    runs-on: 'ubuntu-latest'
    steps:
      - uses: 'actions/checkout@v3'

      - uses: 'actions/setup-node@v3'
        with:
          node-version: '16'
          cache: 'npm'

      - name: 'npm ci'
        run: 'npm ci'

  format:
    name: 'prettier'
    runs-on: 'ubuntu-latest'
    needs: ['setup']
    steps:
      - uses: 'actions/checkout@v3'

      - uses: 'actions/setup-node@v3'
        with:
          node-version: '16'
          cache: 'npm'

      - name: 'npm ci'
        run: 'npm ci'

      - name: 'npm run format:check'
        run: 'npm run format:check'

  lint:
    name: 'eslint'
    runs-on: 'ubuntu-latest'
    needs: ['setup']
    steps:
      - uses: 'actions/checkout@v3'

      - uses: 'actions/setup-node@v3'
        with:
          node-version: '16'
          cache: 'npm'

      - name: 'npm ci'
        run: 'npm ci'

      - name: 'npm run lint'
        run: 'npm run lint'

  tsc:
    name: 'tsc'
    runs-on: 'ubuntu-latest'
    needs: ['setup']
    steps:
      - uses: 'actions/checkout@v3'

      - uses: 'actions/setup-node@v3'
        with:
          node-version: '16'
          cache: 'npm'

      - name: 'npm ci'
        run: 'npm ci'

      - name: 'npm run tsc'
        run: 'npm run tsc'

  test:
    name: 'jest'
    runs-on: 'ubuntu-latest'
    needs: ['setup']
    steps:
      - uses: 'actions/checkout@v3'

      - uses: 'actions/setup-node@v3'
        with:
          node-version: '16'
          cache: 'npm'

      - name: 'npm ci'
        run: 'npm ci'

      - name: 'npm run test'
        run: 'npm run test'

  build:
    name: 'build'
    runs-on: 'ubuntu-latest'
    needs: ['format', 'lint', 'test', 'tsc']
    steps:
      - uses: 'actions/checkout@v3'

      - uses: 'actions/setup-node@v3'
        with:
          node-version: '16'
          cache: 'npm'

      - name: 'npm ci'
        run: 'npm ci'

      - name: 'npm run build'
        run: 'npm run build'

      - name: 'Prepare Output'
        if: ${{ github.event_name == 'push' }}
        run: |
          cp README.md ./actions
          echo ${{ github.ref }} >> ./actions/${{ github.sha }}
          sed -i 's/<!--AUTO-->/This was autogenerated. [Go to ex-actions\/ex-actions for the source](https:\/\/github.com\/ex-actions\/ex-actions)./' ./actions/README.md

      - name: 'Push Build'
        if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
        uses: 's0/git-publish-subdir-action@v2.5.1'
        env:
          REPO: 'self'
          BRANCH: 'build'
          FOLDER: 'actions'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: 'actions/upload-artifact@v3'
        with:
          name: 'compiled-actions'
          path: 'actions'

  deploy:
    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
    name: 'Deploy Actions'
    runs-on: 'ubuntu-latest'
    needs: ['build']
    strategy:
      matrix:
        action: ['mix-deps-get']
    steps:
      - uses: 'actions/checkout@v3'

      - uses: 'actions/download-artifact@v3'
        with:
          name: 'compiled-actions'
          path: 'actions'

      - name: 'Deploy Action'
        uses: 's0/git-publish-subdir-action@v2.5.1'
        env:
          REPO: 'git@github.com:ex-actions/${{ matrix.action }}.git'
          BRANCH: 'main'
          FOLDER: 'actions/${{ matrix.action }}'
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_KEY }}

  test_apps:
    name: 'Test Mix Projects'
    runs-on: 'ubuntu-latest'
    needs: ['build']
    strategy:
      matrix:
        app: ['elixir_app', 'elixir_umbrella', 'test_umbrella', 'erlang_lib']
    defaults:
      run:
        working-directory: 'test/fixtures/${{ matrix.app }}'
    steps:
      - uses: 'actions/checkout@v3'

      - uses: 'actions/download-artifact@v3'
        with:
          name: 'compiled-actions'
          path: 'actions'

      - uses: 'erlef/setup-beam@v1'
        with:
          elixir-version: ${{ env.elixir-version }}
          otp-version: ${{ env.otp-version }}
          version-type: 'strict'

      - uses: './actions/setup-mix'
        with:
          working-directory: 'test/fixtures/${{ matrix.app }}'

      - name: 'mix test'
        run: 'mix test'
